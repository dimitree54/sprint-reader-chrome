# Story 1.19: Refactor Background Service to Use Core Services

## Status
Draft

## Story
**As a** developer finalizing the architecture refactoring,
**I want** the background service modules cleaned up to use the new CoreServices pattern,
**so that** all extension contexts consistently use the service-oriented architecture.

## Acceptance Criteria
1. All background service modules use `BrowserApiService` instead of direct browser API calls
2. All background service modules use `StorageService` instead of direct storage calls
3. Background service follows consistent service instantiation patterns
4. All background service functionality is preserved exactly
5. All existing Playwright tests continue to pass
6. Code quality and organization is improved through service usage

## Tasks / Subtasks
- [ ] Audit background service API usage (AC: 1, 2)
  - [ ] Review `src/background/` modules for direct browser API usage
  - [ ] Review `src/background/` modules for direct storage usage
  - [ ] Identify all modules that need service integration
  - [ ] Document current API usage patterns
- [ ] Migrate background modules to use BrowserApiService (AC: 1)
  - [ ] Update `src/background/index.ts` to use BrowserApiService
  - [ ] Update `src/background/state.ts` to use BrowserApiService
  - [ ] Update `src/background/selection.ts` to use BrowserApiService
  - [ ] Update `src/background/preferences.ts` to use BrowserApiService
  - [ ] Update `src/background/reader-window.ts` to use BrowserApiService
  - [ ] Update `src/background/message-handler.ts` to use BrowserApiService
  - [ ] Update `src/background/listeners.ts` to use BrowserApiService
- [ ] Migrate background modules to use StorageService (AC: 2)
  - [ ] Update modules that handle preference caching
  - [ ] Update modules that manage selection persistence
  - [ ] Update any other storage operations in background
  - [ ] Ensure consistent storage patterns across background
- [ ] Implement consistent service patterns (AC: 3)
  - [ ] Create proper service instantiation in background context
  - [ ] Ensure services are shared appropriately within background
  - [ ] Follow dependency injection patterns where possible
  - [ ] Maintain service lifecycle properly
- [ ] Preserve all functionality (AC: 4)
  - [ ] Test selection synchronization works correctly
  - [ ] Test preference caching and persistence
  - [ ] Test reader window lifecycle management
  - [ ] Test context menu and keyboard shortcuts
  - [ ] Test runtime message handling
- [ ] Comprehensive testing (AC: 5)
  - [ ] Run full Playwright test suite
  - [ ] Test all background service features manually
  - [ ] Test extension installation and update flows
  - [ ] Test all background-to-reader communication
- [ ] Improve code quality (AC: 6)
  - [ ] Remove any duplicate code or logic
  - [ ] Ensure consistent error handling patterns
  - [ ] Improve code organization and readability
  - [ ] Add proper TypeScript types where needed
- [ ] Final verification
  - [ ] Manual testing of complete extension functionality
  - [ ] Test all extension features across different contexts
  - [ ] Run `npm run build:chrome` to verify build integrity
  - [ ] Run `npm run typecheck` and `npm run lint` to ensure code quality

## Dev Notes
### Linting Strategy
- When introducing new lint or type checks, add existing files to the ignore list so the baseline continues to pass.
- Whenever you modify one of the ignored files, remove it from the ignore list and resolve any violations so that the updated code complies with the stricter rules.
- Remove this story's touched files from the `.eslintignore` baseline created in Story 1.1 before committing.


### Architecture Context
This story implements Phase 6, Step 6.1 of the refactoring plan, completing the service integration by ensuring the background service follows the same service-oriented patterns as the reader components.

[Source: docs/refactoring/refactoring_plan.md#phase-6-cleanup-and-finalization]

### Background Service Architecture
The background service currently includes:
- `src/background/index.ts` - Bootstrap and coordination
- `src/background/state.ts` - Selection and preference caching
- `src/background/selection.ts` - Selection state management
- `src/background/preferences.ts` - Preference persistence
- `src/background/reader-window.ts` - Reader window lifecycle
- `src/background/message-handler.ts` - Runtime message routing
- `src/background/listeners.ts` - Commands, menus, events

[Source: docs/architecture.md#background-service-worker]

### Service Integration Pattern
Background modules should use services consistently:
```typescript
// In background context
const browserApi = new BrowserApiService()
const storageService = new StorageService(browserApi)

// Use services instead of direct API calls
await storageService.setReaderPreferences(prefs)
const window = await browserApi.createWindow(options)
```

### Core Responsibilities to Preserve
The background service must continue to:
- Track latest selection synchronized from content scripts
- Persist reader preferences via storage helpers
- Own reader window lifecycle management
- Generate context-menu commands and keyboard shortcuts
- Handle install/update flows

[Source: docs/architecture.md#background-service-worker]

### Technical Requirements
- Must maintain identical background service functionality
- Should follow consistent service instantiation patterns
- Must preserve all existing communication patterns
- Should improve code organization and maintainability

### Service Lifecycle Management
- Services should be instantiated once in background context
- Should be shared across background modules where appropriate
- Must handle service cleanup if needed
- Should follow dependency injection patterns

### Testing Strategy
- Focus on background service functionality preservation
- Test selection synchronization and preference management
- Test reader window management and communication
- Verify all extension features work through background service

### Integration Points
Background service integrates with:
- Content scripts for selection capture
- Reader UI for state synchronization
- Popup for preference access
- Settings page for configuration management

### Expected Results
After this story:
- Background service uses consistent service patterns
- All extension contexts follow service-oriented architecture
- Code quality and organization improved
- Foundation complete for future maintenance

### Critical Success Criteria
- All background service functionality preserved
- Consistent service usage across entire extension
- All tests passing
- Improved code organization and maintainability

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-25 | 1.0 | Initial story creation | Scrum Master |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

## QA Results
*This section will be populated by the QA agent after implementation review*