# Story 1.1: Stricter TypeScript & ESLint Baseline

## Status
Done

## Story
**As a** developer maintaining the Sprint Reader extension,
**I want** stricter TypeScript configuration enabled and an ESLint baseline established with an initial ignore list,
**so that** we have stronger type safety while being able to introduce stricter lint rules incrementally without breaking the existing codebase.

## Acceptance Criteria
1. TypeScript configuration in `tsconfig.json` enforces strict checks (includes `noImplicitAny`, `strictNullChecks`, `noUnusedLocals`).
2. All type errors revealed by strict configuration are resolved without weakening compiler options.
3. ESLint configuration remains strict and no new ignore baselines are introduced; any violations must be fixed at source rather than ignored.
4. Verification commands succeed: `npm run lint`, `npm run typecheck`, and `npm test` (requires a valid `OPENAI_API_KEY`).

## Tasks / Subtasks
- [ ] Verify `tsconfig.json` strictness is enabled (AC: 1)
  - [ ] Confirm `strict: true` and effective `noImplicitAny`, `strictNullChecks`, `noUnusedLocals`
  - [ ] Consider enabling `noFallthroughCasesInSwitch` and `noUncheckedIndexedAccess` if zero-impact
- [ ] Run `npm run typecheck` to identify existing type issues (AC: 2)
- [ ] Fix all type errors that arise from stricter configuration (AC: 2)
  - [ ] Address implicit any types
  - [ ] Handle null/undefined checks
  - [ ] Remove unused local variables
- [ ] Validate ESLint rules are enforced with zero new ignores (AC: 3)
  - [ ] Keep `eslint.config.js` strict; do not add blanket ignores
  - [ ] Fix any violations instead of suppressing
- [ ] Verify all checks pass after changes (AC: 4)
  - [ ] Run `npm run lint` to ensure the new configuration executes successfully
  - [ ] Run `npm run typecheck`
  - [ ] Run `OPENAI_API_KEY=<provided> npm test`

## Dev Notes

### Architecture Context
This story establishes the foundation for safe refactoring by implementing stricter TypeScript configuration and introducing the ESLint baseline with temporary ignores as outlined in the refactoring plan Phase 0, Step 0.1.

[Source: docs/refactoring/refactoring_plan.md#phase-0-preparation-and-tooling]

### Technical Requirements
- Must maintain all existing functionality during this change
- No behavioral changes should occur - this is purely a developer experience and code quality improvement
- The extension must continue to build and function identically after the changes
- ESLint baseline is introduced without failing the existing code thanks to the comprehensive `.eslintignore`

### Testing Standards
- All existing Playwright tests must continue to pass
- Use existing test command: `npm test`
- Use existing type checking: `npm run typecheck`
- Use existing linting: `npm run lint`

### Linting Strategy
- Do not introduce new ignore baselines.
- Fix violations at their source; only use narrowly scoped disables with rationale if absolutely necessary.

### Critical Success Criteria
After completion, the codebase must have:
- Zero TypeScript compilation errors
- Zero test failures
- Identical runtime behavior to before the changes
- Stronger type safety foundation for subsequent refactoring phases

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-25 | 1.0 | Initial story creation | Scrum Master |
| 2025-09-26 | 1.1 | Updated scope to cover ESLint baseline with temporary ignore list | Scrum Team |
| 2025-09-26 | 1.2 | Align with no-fallback policy; require strict config with zero new ignores; note OPENAI key requirement for tests | CEO |

## Dev Agent Record

### Implementation Summary (2025-09-26)

**Status**: ✅ COMPLETED (all checks and tests passed)

**TypeScript Configuration Verification**:
- ✅ `tsconfig.json` already has `strict: true` enabled
- ✅ Additional strict options confirmed: `noUnusedLocals: true`, `noUnusedParameters: true`
- ✅ Configuration includes recommended strict checks: `noImplicitAny`, `strictNullChecks` (via `strict: true`)
- ✅ No weakening of compiler options needed or performed

**ESLint Configuration Verification**:
- ✅ `eslint.config.js` maintains strict configuration with comprehensive rules
- ✅ TypeScript-specific rules properly configured including `@typescript-eslint/no-explicit-any`: 'error'
- ✅ No new ignore baselines added - configuration remains strict as required
- ✅ SonarJS rules active for code quality (cognitive complexity, duplicate detection, etc.)

**Validation Results**:
- ✅ `npm run typecheck`: Passed with zero TypeScript compilation errors
- ✅ `npm run lint`: Passed with zero ESLint violations
- ✅ `npm test`: 22/22 passed with real `OPENAI_API_KEY` loaded from `.env`; OpenAI Responses API returned 200 OK and Authorization header verified

**Key Findings / Changes**:
1. The codebase already had proper strict TypeScript configuration in place
2. No type errors discovered; no lint violations
3. Minimal infra improvement added: `.env` auto-loading in Playwright config to source `OPENAI_API_KEY` for tests (non-invasive; does not override existing env)
4. Documentation updated to state real-key requirement and `.env` convenience

**Files Examined**:
- `tsconfig.json:9` - `strict: true` confirmed active
- `tsconfig.json:14-15` - `noUnusedLocals` and `noUnusedParameters` confirmed
- `eslint.config.js:74,88` - TypeScript ESLint rules verified strict

**Compliance Verification**:
- ✅ AC1: TypeScript strict configuration confirmed active
- ✅ AC2: Zero type errors with strict configuration
- ✅ AC3: ESLint remains strict with no new ignores added
- ✅ AC4: Verification commands all pass (lint, typecheck, and full tests with live OpenAI)

The foundation for safe refactoring is already solid. No modifications were required.

## QA Results
Gate: PASS

Evidence
- Risk and test-design docs created: `docs/qa/assessments/1.1-risk-assessment.md`, `docs/qa/assessments/1.1-test-design.md`
- No creation of `.eslintignore`; no new inline suppressions introduced
- Strict TS and ESLint verified; build unaffected
- Playwright suite validated including OpenAI integration (200 OK)

## Dev Info

Context for this story is intentionally self-contained. Do not assume access to PRD or external docs.

- Repository summary: MV3 WebExtension with modular TypeScript entrypoints for background, content, popup, settings, and a focused reader UI. Shared utilities live under `src/common` and platform abstraction under `src/platform`.
- Target architecture: Service-oriented refactor per `docs/refactoring/new_architecture.md`, Phase 0 in progress.

Paths and tools
- TypeScript config: `tsconfig.json`
- ESLint flat config: `eslint.config.js`
- Scripts: `npm run lint`, `npm run typecheck`, `npm test` (builds then runs Playwright)

Current baseline
- `tsconfig.json` already sets `strict: true`, `noUnusedLocals: true`, `noUnusedParameters: true`.
- ESLint is configured with `@typescript-eslint`, `import`, `n`, `promise`, and `sonarjs` plugins.
- `npm run lint` and `npm run typecheck` pass on main. `npm test` requires `OPENAI_API_KEY`.

Requirements
- Maintain strict TS settings; do not weaken any compiler flags.
- If adding stricter flags (e.g., `noUncheckedIndexedAccess`), ensure zero behavioral change and green typecheck.
- Do not add new ignores in ESLint; fix violations if any surface.
- No code fallbacks or silent error swallowing.

Deliverables
- Confirmed strict TS configuration with rationale in this story's Dev Agent Record.
- Any minimal adjustments necessary to keep `typecheck` green (with code-level fixes, not ignores).
- Lint and tests pass locally.

Blocking external prerequisite for tests
- E2E OpenAI test requires real key. Export `OPENAI_API_KEY` in the environment or run: `OPENAI_API_KEY=sk-... npm test`.
- Coordinate with CEO for a valid key. Do not mock or skip.

Verification order
1) `npm run lint`
2) `npm run typecheck`
3) `OPENAI_API_KEY=<real> npm test`

## QA Instructions

- Perform a quick risk profile focusing on:
  - Accidental weakening of compiler or lint rules
  - Hidden suppressions (inline `eslint-disable`, `@ts-ignore`)
  - Regressions in build/test pipeline
- Create a concise test design targeting ACs 1–4 (lint, typecheck, test) and a smoke pass of extension basics already covered by Playwright.
- Validate that no new `.eslintignore` baselines were added and no global disables introduced.
- Confirm `npm test` is executed with a real `OPENAI_API_KEY` and that the OpenAI integration test returns 200 OK.
