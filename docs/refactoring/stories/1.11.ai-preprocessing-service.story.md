# Story 1.11: Create AIPreprocessingService

## Status
Draft

## Story
**As a** developer refactoring the Sprint Reader extension,
**I want** a centralized AIPreprocessingService that handles text preprocessing and AI interactions,
**so that** AI preprocessing logic is extracted into a testable service and properly abstracted from the reader UI.

## Acceptance Criteria
1. `AIPreprocessingService` class is created in `src/preprocessing/ai-preprocessing.service.ts`
2. All existing logic from the `src/preprocessing` directory is refactored into the service class
3. Service handles both translation and summarization operations through OpenAI API
4. Service includes proper error handling and timeout management
5. Unit tests are created for the service with mocked fetch calls
6. All existing Playwright tests related to OpenAI features continue to pass
7. Service maintains compatibility with existing preprocessing provider pattern

## Tasks / Subtasks
- [ ] Create AIPreprocessingService class structure (AC: 1)
  - [ ] Create `src/preprocessing/ai-preprocessing.service.ts` file
  - [ ] Define AIPreprocessingService class with appropriate methods
  - [ ] Set up proper TypeScript interfaces for preprocessing operations
- [ ] Migrate existing preprocessing logic (AC: 2)
  - [ ] Refactor logic from `src/preprocessing/providers/openai.ts` into service
  - [ ] Refactor logic from `src/preprocessing/manager.ts` into service
  - [ ] Refactor logic from `src/preprocessing/streaming-manager.ts` into service
  - [ ] Preserve all existing provider architecture patterns
- [ ] Implement core preprocessing operations (AC: 3)
  - [ ] Create `translateText(text: string, targetLanguage: string): Promise<string>` method
  - [ ] Create `summarizeText(text: string, level: string): Promise<string>` method
  - [ ] Create `isAvailable(): boolean` method to check API key availability
  - [ ] Integrate with OpenAI API endpoints properly
- [ ] Implement error handling and resilience (AC: 4)
  - [ ] Add 10-second timeout handling as per current implementation
  - [ ] Add proper error handling for API failures
  - [ ] Add graceful fallback mechanisms
  - [ ] Add retry logic where appropriate
- [ ] Create comprehensive unit tests (AC: 5)
  - [ ] Create `src/preprocessing/ai-preprocessing.service.spec.ts` test file
  - [ ] Mock fetch calls for API interactions
  - [ ] Test successful translation operations
  - [ ] Test successful summarization operations
  - [ ] Test error conditions (API failures, timeouts)
  - [ ] Test availability checking logic
  - [ ] Test with different target languages
  - [ ] Follow AAA pattern (Arrange, Act, Assert)
- [ ] Maintain OpenAI feature compatibility (AC: 6)
  - [ ] Ensure existing OpenAI features continue to work
  - [ ] Test translation functionality in browser
  - [ ] Test summarization functionality in browser
  - [ ] Verify API key management continues to work
- [ ] Preserve provider pattern compatibility (AC: 7)
  - [ ] Maintain existing PreprocessingProvider interface compliance
  - [ ] Ensure service can be used as a drop-in replacement
  - [ ] Preserve metadata and result formatting
- [ ] Verification and testing
  - [ ] Run unit tests to ensure service functionality
  - [ ] Run `npm test` to ensure all Playwright tests pass
  - [ ] Run `npm run build:chrome` to verify build integrity
  - [ ] Test OpenAI features manually in browser
  - [ ] Run `npm run typecheck` and `npm run lint` to ensure code quality

## Dev Notes

### Architecture Context
This story implements Phase 3, Step 3.2 of the refactoring plan, extracting AI preprocessing logic into a testable service. This is crucial for isolating external API dependencies and making them testable.

[Source: docs/refactoring/refactoring_plan.md#phase-3-service-layer-extraction]

### Current Preprocessing Architecture
The extension has a provider-based architecture for text preprocessing:
- `src/preprocessing/providers/openai.ts` - OpenAI API integration
- `src/preprocessing/providers/passthrough.ts` - No-op fallback provider
- `src/preprocessing/manager.ts` - Provider selection and fallback logic
- `src/preprocessing/streaming-manager.ts` - Real-time streaming coordination

[Source: docs/architecture.md#text-preprocessing-architecture]

### AI Preprocessing Features
The service must support:
- Text translation to configured target languages
- Text summarization at different levels
- Real-time streaming processing
- 10-second timeout handling
- Graceful fallback to passthrough provider

[Source: docs/architecture.md#current-providers]

### Service Interface Design
```typescript
interface PreprocessingResult {
  text: string
  metadata?: {
    originalLength: number
    processedLength: number
    wasModified: boolean
    provider: string
    processingTime?: number
  }
}

class AIPreprocessingService {
  async translateText(text: string, targetLanguage: string): Promise<PreprocessingResult>
  async summarizeText(text: string, level: string): Promise<PreprocessingResult>
  async isAvailable(): Promise<boolean>
  async processWithStreaming(text: string, onChunk: (chunk: string) => void): Promise<PreprocessingResult>
}
```

### Technical Requirements
- Must use proper fetch API with timeout handling
- Should integrate with existing API key management through StorageService
- Must maintain all existing error handling and retry logic
- Should preserve streaming capabilities for real-time processing

### Security Considerations
- API keys must never be logged or exposed in error messages
- Must use secure storage for API key persistence
- Should validate API responses for security

[Source: docs/architecture.md#security-considerations]

### Testing Requirements
Unit tests must cover:
- Successful API interactions (mocked)
- Error conditions and timeout handling
- Different language and summarization options
- Availability checking logic
- Streaming functionality

### Migration Strategy
The service will initially coexist with existing preprocessing modules. Subsequent stories will migrate the reader to use this service instead of direct preprocessing calls.

### Testing Standards
- Create comprehensive unit tests using Vitest with fetch mocking
- Test all API interaction scenarios
- Ensure existing OpenAI-related Playwright tests continue to pass
- Manual verification of OpenAI features in browser

### Linting Strategy
- When introducing new lint or type checks, add existing files to the ignore list so the baseline continues to pass.
- Whenever you modify one of the ignored files, remove it from the ignore list and resolve any violations so that the updated code complies with the stricter rules.
- Remove this story's touched files from the `.eslintignore` baseline created in Story 1.1 before committing.


### Critical Success Criteria
- All AI preprocessing logic centralized in testable service
- OpenAI features continue to work correctly
- Comprehensive test coverage with mocked external dependencies
- Service ready for integration with reader components

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-25 | 1.0 | Initial story creation | Scrum Master |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

## QA Results
*This section will be populated by the QA agent after implementation review*