# Story 1.7: Migrate All Storage Calls to StorageService

## Status
Draft

## Story
**As a** developer refactoring the Sprint Reader extension,
**I want** all parts of the application migrated to use the StorageService,
**so that** storage operations are centralized, testable, and consistently managed throughout the extension.

## Acceptance Criteria
1. All parts of the application that call storage functions are updated to use the new `StorageService`
2. Background service storage usage is migrated to `StorageService`
3. Popup storage usage is migrated to `StorageService`
4. Reader UI storage usage is migrated to `StorageService`
5. Settings page storage usage is migrated to `StorageService`
6. All existing Playwright tests continue to pass, especially settings page tests
7. Storage operations (preference loading and saving) work correctly in browser

## Tasks / Subtasks
- [ ] Identify all storage usage locations (AC: 1)
  - [ ] Scan codebase for imports from `src/common/storage.ts`
  - [ ] Scan for direct browser storage API calls
  - [ ] Create comprehensive list of files needing migration
- [ ] Migrate background service storage usage (AC: 2)
  - [ ] Update `src/background/preferences.ts` to use StorageService
  - [ ] Update `src/background/state.ts` storage operations
  - [ ] Update any other background files using storage
  - [ ] Ensure proper service instantiation in background context
- [ ] Migrate popup storage usage (AC: 3)
  - [ ] Update `src/popup/index.ts` to use StorageService
  - [ ] Replace storage helper imports with StorageService
  - [ ] Ensure proper service instantiation in popup context
- [ ] Migrate reader UI storage usage (AC: 4)
  - [ ] Update `src/reader/selection-loader.ts` to use StorageService
  - [ ] Update any other reader files using storage
  - [ ] Ensure proper service instantiation in reader context
- [ ] Migrate settings page storage usage (AC: 5)
  - [ ] Update `src/settings/index.ts` to use StorageService
  - [ ] Ensure OpenAI API key storage/retrieval works correctly
  - [ ] Ensure preference storage/retrieval works correctly
  - [ ] Test settings page functionality thoroughly
- [ ] Handle service instantiation and dependency management
  - [ ] Create appropriate StorageService instances in each context
  - [ ] Ensure BrowserApiService is properly injected
  - [ ] Handle service lifecycle and sharing appropriately
- [ ] Verification and testing (AC: 6, 7)
  - [ ] Run `npm test` to ensure all Playwright tests pass
  - [ ] Run settings page tests specifically to verify storage functionality
  - [ ] Run `npm run build:chrome` to verify build integrity
  - [ ] Test storage operations manually in browser
  - [ ] Test preference changes persist correctly
  - [ ] Test OpenAI settings save/load correctly
  - [ ] Run `npm run lint` and `npm run typecheck` to ensure code quality

## Dev Notes

### Architecture Context
This story implements Phase 1, Step 1.4 of the refactoring plan, completing the storage abstraction by migrating all calling code to use the StorageService. This is critical for ensuring consistent storage operations.

[Source: docs/refactoring/refactoring_plan.md#phase-1-core-services-abstraction]

### Current Storage Usage Locations
Based on the architecture, storage is used in:
- Background worker for preference caching and persistence
- Popup for loading and saving reader preferences
- Settings page for OpenAI API key and configuration management
- Reader UI for loading preferences and selection state

[Source: docs/architecture.md#execution-contexts]

### Critical Storage Operations
The migration must preserve:
- Reader preference loading/saving (words-per-minute, theme)
- OpenAI API key and configuration persistence
- Selection state management in background worker
- Settings page save/load functionality

### Service Instantiation Strategy
Each execution context needs proper service setup:
```typescript
// In each context
const browserApi = new BrowserApiService()
const storageService = new StorageService(browserApi)
```

### Testing Focus Areas
Critical test areas:
- Settings page tests (API key save/load, preference changes)
- Reader preference persistence
- Background state synchronization
- Cross-context storage consistency

### Expected Code Changes
Replace patterns like:
```typescript
// Before
import { getStoredPreferences, setStoredPreferences } from '../common/storage.js'
const prefs = await getStoredPreferences()
await setStoredPreferences(newPrefs)

// After
import { StorageService } from '../core/storage.service.js'
const storageService = new StorageService(browserApiService)
const prefs = await storageService.getReaderPreferences()
await storageService.setReaderPreferences(newPrefs)
```

### Testing Standards
- All existing Playwright tests must continue to pass without modification
- Settings page tests are particularly critical for this story
- Manual testing required for storage operations in browser
- Focus on data persistence verification

### Linting Strategy
- When introducing new lint or type checks, add existing files to the ignore list so the baseline continues to pass.
- Whenever you modify one of the ignored files, remove it from the ignore list and resolve any violations so that the updated code complies with the stricter rules.
- Remove this story's touched files from the `.eslintignore` baseline created in Story 1.1 before committing.


### Critical Success Criteria
- All storage operations migrated to use StorageService
- Settings page functionality working correctly (major risk area)
- All preference loading/saving operations preserved
- No data loss or corruption during migration
- All existing tests continue to pass

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-25 | 1.0 | Initial story creation | Scrum Master |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

## QA Results
*This section will be populated by the QA agent after implementation review*