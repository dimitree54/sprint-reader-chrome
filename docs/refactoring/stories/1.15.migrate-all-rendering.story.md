# Story 1.15: Migrate All Rendering Logic to Renderer

## Status
Draft

## Story
**As a** developer refactoring the Sprint Reader extension,
**I want** all remaining DOM manipulation logic moved to the Renderer,
**so that** the Renderer becomes the single source of DOM updates and the UI is completely driven by the Zustand store.

## Acceptance Criteria
1. All DOM manipulation logic from `render.ts` is moved to the Renderer
2. All visual effects logic from `visual-effects.ts` is moved to the Renderer
3. All remaining DOM manipulation from old `controls.ts` is moved to the Renderer
4. The Renderer handles all UI updates: progress bar, status text, theme changes, word highlighting
5. All UI-related Playwright tests are re-enabled and pass
6. Complete UI is now driven by the Zustand store
7. No direct DOM manipulation remains outside the Renderer
8. Unit tests cover newly introduced renderer helpers and visual-effects functions migrated in this story (Vitest + JSDOM); untouched legacy code can remain without additional tests

## Tasks / Subtasks
- [ ] Audit remaining DOM manipulation locations (AC: 7)
  - [ ] Identify all DOM updates in `src/reader/render.ts`
  - [ ] Identify all DOM updates in `src/reader/visual-effects.ts`
  - [ ] Identify any remaining DOM updates in old `src/reader/controls.ts`
  - [ ] Identify any other scattered DOM manipulation in reader modules
- [ ] Migrate core rendering logic (AC: 1)
  - [ ] Move word display updates from `render.ts` to Renderer
  - [ ] Move progress bar updates from `render.ts` to Renderer
  - [ ] Move status text updates from `render.ts` to Renderer
  - [ ] Move play/pause visual state updates from `render.ts` to Renderer
  - [ ] Preserve all existing rendering behavior exactly
- [ ] Migrate visual effects logic (AC: 2)
  - [ ] Move letter highlighting logic from `visual-effects.ts` to Renderer
  - [ ] Move word positioning logic from `visual-effects.ts` to Renderer
  - [ ] Move flicker effects logic from `visual-effects.ts` to Renderer
  - [ ] Move CSS transform handling from `visual-effects.ts` to Renderer
  - [ ] Ensure all visual effects respond to store state changes
- [ ] Migrate remaining controls rendering (AC: 3)
  - [ ] Move any remaining DOM updates from old `controls.ts` to Renderer
  - [ ] Move theme application logic to Renderer
  - [ ] Move UI state visual feedback to Renderer
- [ ] Implement comprehensive UI updates (AC: 4)
  - [ ] Ensure progress bar updates reactively to store state
  - [ ] Ensure status text updates reactively to store state
  - [ ] Ensure theme changes apply reactively from store state
  - [ ] Ensure word highlighting updates reactively to store state
  - [ ] Ensure all visual effects respond to store changes
- [ ] Re-enable and fix UI tests (AC: 5)
  - [ ] Re-enable previously disabled UI-related Playwright tests
  - [ ] Fix any test failures caused by the new reactive system
  - [ ] Ensure theme switching tests pass
  - [ ] Ensure progress bar tests pass
  - [ ] Ensure visual effects tests pass
- [ ] Verify complete store-driven UI (AC: 6)
  - [ ] Test that all UI updates are triggered by store changes
  - [ ] Verify no direct DOM manipulation bypasses the store
  - [ ] Test complete reactive cycle from user interaction to DOM update
  - [ ] Ensure all UI state is managed through the store
- [ ] Final verification and cleanup
  - [ ] Run full test suite to ensure all tests pass
  - [ ] Test complete reader functionality in browser
  - [ ] Verify all UI interactions work correctly
  - [ ] Run `npm run build:chrome` to verify build integrity
  - [ ] Run `npm run typecheck` and `npm run lint` to ensure code quality

## Dev Notes
### Linting Strategy
- When introducing new lint or type checks, add existing files to the ignore list so the baseline continues to pass.
- Whenever you modify one of the ignored files, remove it from the ignore list and resolve any violations so that the updated code complies with the stricter rules.
- Remove this story's touched files from the `.eslintignore` baseline created in Story 1.1 before committing.


### Architecture Context
This story implements Phase 4, Step 4.3 of the refactoring plan, completing the UI decoupling by centralizing all DOM manipulation in the Renderer. This finalizes the reactive UI architecture.

[Source: docs/refactoring/refactoring_plan.md#phase-4-isolate-rendering-and-user-controls]

### Current Rendering Distribution
DOM manipulation is currently scattered across:
- `src/reader/render.ts` - Main word display, progress, status updates
- `src/reader/visual-effects.ts` - Letter highlighting, positioning, effects
- `src/reader/controls.ts` - Theme application, UI control feedback
- Various other reader modules with direct DOM access

[Source: docs/architecture.md#reader-ui-modular-architecture]

### Complete Renderer Design
The final Renderer should handle:
```typescript
class Renderer {
  private unsubscribe: () => void

  constructor() {
    this.unsubscribe = useReaderStore.subscribe((state, prevState) => {
      this.updateWordDisplay(state.words[state.playbackIndex])
      this.updateProgress(state.progress)
      this.updateStatus(state.statusMessage)
      this.updateTheme(state.theme)
      this.updatePlayPauseVisual(state.status)
      this.applyVisualEffects(state.visualEffects)
    })
  }

  private updateWordDisplay(word: WordItem) { /* DOM updates */ }
  private updateProgress(progress: number) { /* DOM updates */ }
  private updateStatus(status: string) { /* DOM updates */ }
  private updateTheme(theme: string) { /* DOM updates */ }
  private updatePlayPauseVisual(status: PlaybackStatus) { /* DOM updates */ }
  private applyVisualEffects(effects: VisualEffects) { /* DOM updates */ }
}
```

### Visual Effects Integration
All visual effects must be migrated:
- Letter highlighting and positioning
- Word flicker effects for concentration
- CSS transforms for letter centering
- Individual letter span wrapping for styling

[Source: docs/architecture.md#visual-effects]

### Technical Requirements
- Must preserve all existing visual behavior exactly
- Should maintain performance characteristics
- Must ensure all DOM updates are reactive to store changes
- Should handle store state initialization properly

### Testing Strategy
This story requires comprehensive testing:
- Add unit tests for new/refactored pure helpers and DOM update functions in the Renderer (use Vitest + JSDOM). Focus on newly introduced code.
- Re-enable all UI-related Playwright tests
- Manual verification of all visual effects
- Test complete user interaction flows
- Verify theme switching, progress updates, word highlighting

### Store State Requirements
The store must contain all state needed for rendering:
- Current word and highlighting information
- Progress percentage
- Status messages
- Theme settings
- Visual effect configurations

### Critical UI Components
All these must be store-driven:
- Word display area
- Progress bar
- Status text
- Play/pause button visual state
- Theme application (light/dark)
- Font size and styling
- Letter highlighting and positioning

### Expected Results
After this story:
- All DOM manipulation centralized in Renderer
- Complete reactive UI system operational
- All UI tests passing
- Reader fully functional with new architecture

### Critical Success Criteria
- All UI updates driven by store changes only
- No direct DOM manipulation outside Renderer
- All existing visual behavior preserved
- All UI tests passing
- Complete reactive architecture operational

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-25 | 1.0 | Initial story creation | Scrum Master |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

## QA Results
*This section will be populated by the QA agent after implementation review*
