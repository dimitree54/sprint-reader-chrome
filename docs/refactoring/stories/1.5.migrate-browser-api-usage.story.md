# Story 1.5: Migrate Code to Use BrowserApiService

## Status
Draft

## Story
**As a** developer refactoring the Sprint Reader extension,
**I want** all direct browser API usage migrated to use the BrowserApiService,
**so that** browser API interactions are centralized and the codebase becomes more testable and maintainable.

## Acceptance Criteria
1. All direct usages of `browser` or `chrome` APIs throughout the codebase are replaced with `BrowserApiService` calls
2. Background service (`src/background/`) uses BrowserApiService instead of direct browser APIs
3. Popup (`src/popup/`) uses BrowserApiService instead of direct browser APIs
4. Content script (`src/content/`) uses BrowserApiService instead of direct browser APIs
5. All existing Playwright tests continue to pass
6. Application functionality remains completely unchanged

## Tasks / Subtasks
- [ ] Identify all direct browser API usage locations (AC: 1)
  - [ ] Scan `src/background/` files for direct `browser`/`chrome` API calls
  - [ ] Scan `src/popup/` files for direct `browser`/`chrome` API calls
  - [ ] Scan `src/content/` files for direct `browser`/`chrome` API calls
  - [ ] Scan any other locations that import from `src/platform/browser.ts`
- [ ] Migrate background service usage (AC: 2)
  - [ ] Update `src/background/index.ts` to use BrowserApiService
  - [ ] Update `src/background/state.ts` to use BrowserApiService
  - [ ] Update `src/background/selection.ts` to use BrowserApiService
  - [ ] Update `src/background/preferences.ts` to use BrowserApiService
  - [ ] Update `src/background/reader-window.ts` to use BrowserApiService
  - [ ] Update `src/background/message-handler.ts` to use BrowserApiService
  - [ ] Update `src/background/listeners.ts` to use BrowserApiService
- [ ] Migrate popup usage (AC: 3)
  - [ ] Update `src/popup/index.ts` to use BrowserApiService
  - [ ] Replace any direct browser API calls with service methods
- [ ] Migrate content script usage (AC: 4)
  - [ ] Update `src/content/index.ts` to use BrowserApiService
  - [ ] Replace any direct browser API calls with service methods
- [ ] Handle service instantiation and dependency injection
  - [ ] Create appropriate service instances in each context
  - [ ] Ensure proper service lifecycle management
  - [ ] Handle service sharing where appropriate
- [ ] Verification and testing (AC: 5, 6)
  - [ ] Run `npm test` to ensure all Playwright tests pass
  - [ ] Run `npm run build:chrome` to verify build integrity
  - [ ] Test extension manually in browser to verify functionality
  - [ ] Run `npm run lint` and `npm run typecheck` to ensure code quality

## Dev Notes

### Architecture Context
This story implements Phase 1, Step 1.2 of the refactoring plan, migrating all calling code to use the new BrowserApiService abstraction. This completes the browser API abstraction layer.

[Source: docs/refactoring/refactoring_plan.md#phase-1-core-services-abstraction]

### Current Architecture Context
The extension has four main execution contexts that currently use direct browser APIs:
- Background Service Worker (`src/background/index.ts`)
- Content Script (`src/content/index.ts`)
- Popup (`src/popup/index.ts`)
- Reader UI (`src/reader/index.ts`)

[Source: docs/architecture.md#execution-contexts]

### Migration Strategy
Each context will need to:
1. Import the BrowserApiService
2. Create or receive a service instance
3. Replace direct `browser.*` or `chrome.*` calls with service method calls
4. Maintain identical functionality and behavior

### Technical Requirements
- Service instantiation should follow dependency injection patterns where possible
- Each execution context may need its own service instance
- Must maintain cross-browser compatibility (Chrome/Firefox/Safari)
- All existing functionality must be preserved exactly

### Expected Code Changes
Replace patterns like:
```typescript
// Before
import { browser } from '../platform/browser.js'
await browser.runtime.sendMessage(message)

// After
import { BrowserApiService } from '../core/browser-api.service.js'
const browserApi = new BrowserApiService() // or inject
await browserApi.sendMessage(message)
```

### Testing Standards
- All existing Playwright tests must continue to pass without modification
- No new test requirements for this migration
- Manual browser testing required to verify extension behavior unchanged
- Focus on functional equivalence verification

### Linting Strategy
- When introducing new lint or type checks, add existing files to the ignore list so the baseline continues to pass.
- Whenever you modify one of the ignored files, remove it from the ignore list and resolve any violations so that the updated code complies with the stricter rules.

### Critical Success Criteria
- All direct browser API usage eliminated from application code
- Browser API interactions centralized through service
- No functional regression in extension behavior
- All existing tests continue to pass
- Codebase prepared for easier unit testing in future phases

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-25 | 1.0 | Initial story creation | Scrum Master |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

## QA Results
*This section will be populated by the QA agent after implementation review*