# Story 1.4: Test stability and correctness improvements

Status: Done

## Story
**As a** maintainer,
**I want** stable E2E and unit tests with robust assertions,
**so that** regressions are accurately detected without flaky failures.

## Acceptance Criteria
1. Improved‑word‑grouping spec waits for readerStore readiness before reading `wordItems`.
2. Timing‑algorithms spec: `avgLongDuration > avgShortDuration` and whitespace splitting uses `/\s+/`.
3. Word‑flicker defaults spec imports `DEFAULTS` and asserts `wordFlickerPercent` against it.
4. Text‑selection‑and‑popup spec waits for tokens before evaluation.
5. Preprocessing‑toggle spec waits for word render and normalizes spaces before punctuation.
6. Storage service unit test uses a persisted mock store for true round‑trip and asserts exact values; includes a defaults‑fallback case.
7. Playback service spec clears timers between tests with `playbackService.pause()`.
8. Quality gates pass.

## Tasks / Subtasks
- [x] Playwright readiness waits
  - [x] `tests/playwright/improved-word-grouping.spec.ts`: add `waitForFunction` until `wordItems.length>0`. (AC: 1)
  - [x] `tests/playwright/text-selection-and-popup.spec.ts`: add waits for tokens before evaluations. (AC: 4)
- [x] Assertions and normalization
  - [x] `tests/playwright/timing-algorithms.spec.ts`: assert `avgLongDuration > avgShortDuration`; split with `/\s+/`. (AC: 2)
  - [x] `tests/playwright/preprocessing-toggle.spec.ts`: wait for `#word` non‑empty; normalize spaces before punctuation and trim for comparison. (AC: 5)
  - [x] `tests/playwright/word-flicker-defaults.spec.ts`: import `DEFAULTS` and use it in assertion. (AC: 3)
- [x] Storage unit tests
  - [x] `src/core/storage.service.spec.ts`: persist mocked store in module scope; implement getStorage/setStorage; strengthen round‑trip assertion and add defaults case. (AC: 6)
- [x] Playback unit tests
  - [x] `src/reader/playback/playback.service.spec.ts`: call `playbackService.pause()` in `afterEach`. (AC: 7)

## Dev Notes
Architecture/testing policy:
- Unit and E2E tests are essential quality gates; use realistic behavior without hiding failures via mocks except where explicitly intended for units. [Source: architecture.md#7.-testing-strategy]

Files impacted:
- Multiple tests under `tests/playwright/` and `src/**/*.spec.ts` as listed above.

Testing
- Run `npm test`; with and without `OPENAI_API_KEY` observe expected behavior for integration tests.

Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-27 | 0.1 | Draft story created | Scrum Master |
