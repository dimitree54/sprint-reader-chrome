# Story 1.3: Preprocessing gating correctness (streaming vs. disabled)

Status: Done

## Story
**As a** privacy‑conscious user,
**I want** AI preprocessing and streaming to respect my enable/disable toggle,
**so that** no OpenAI calls occur when preprocessing is disabled, even if an API key is present.

## Acceptance Criteria
1. `StreamingPreprocessingManager` starts streaming only when `config.enabled === true` and the OpenAI provider is available; redundant `config.apiKey` check removed.
2. `AIPreprocessingService.processWithStreaming` short‑circuits to non‑streaming manager when `config.enabled === false`.
3. Unit tests cover both branches for enabled and disabled configurations.
4. Quality gates pass.

## Tasks / Subtasks
- [x] Streaming gate enforcement
  - [x] In `src/preprocessing/streaming-manager.ts`, use `if (config.enabled && openAiProvider.isAvailable(config))` gate; removed redundant apiKey predicate. (AC: 1)
- [x] Respect enabled in streaming API path
  - [x] In `src/preprocessing/ai-preprocessing.service.ts`, early return to `this.manager.process(text, cfg)` when `!cfg.enabled`. (AC: 2)
- [x] Tests
  - [x] Updated unit tests to cover both enabled/disabled branches; ensured no token callback when disabled. (AC: 3)
  - [x] In `src/preprocessing/ai-preprocessing.service.spec.ts`, include `enabled` in mocks and align `shouldSkipProcessing`. (AC: 3)

## Dev Notes
Architecture references:
- Preprocessing provider pattern and gating live under `src/preprocessing/` with config and manager. [Source: architecture.md#7.5.-text-preprocessing-architecture]
- Streaming orchestration runs within reader and must degrade gracefully when disabled. [Source: architecture.md#7.6.-real-time-streaming-architecture]

Files impacted:
- `src/preprocessing/streaming-manager.ts`, `src/preprocessing/ai-preprocessing.service.ts`, `src/preprocessing/ai-preprocessing.service.spec.ts`.

Testing
- E2E: `tests/playwright/preprocessing-toggle.spec.ts` confirms original text when disabled and zero network calls to OpenAI.
- Unit: verify branch behavior and error handling.

Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-27 | 0.1 | Draft story created | Scrum Master |
