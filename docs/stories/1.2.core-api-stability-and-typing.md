# Story 1.2: Core API robustness and typing improvements

Status: Draft

## Story
**As a** developer,
**I want** robust cross‑browser storage APIs, clean singleton resets for tests, and accurate type wrappers,
**so that** the extension works reliably across Chrome/Firefox and unit tests remain deterministic with strong typing.

## Acceptance Criteria
1. `browserApi.getStorage/setStorage` support both Promise‑based (Firefox/webextension‑polyfill) and callback‑based (Chrome) signatures.
2. `StorageService` no longer depends on `common/storage-helpers` for reads that cause circular import; it uses a private `readValue` helper.
3. `BrowserApiService.__resetForTests()` clears the cached browser and the singleton instance to enable re‑adapting in tests.
4. `ChromeAdapter.wrapSendMessage` has overloads for runtime/tabs; remove unsafe casts in adapt() and preserve accurate call signatures.
5. `.env` loader in `playwright.config.ts` strips matching quotes from values before setting `process.env`.
6. Quality gates: `npm run lint`, `npm run typecheck`, `npm test` all pass.

## Tasks / Subtasks
- [ ] Cross‑browser storage API support
  - [ ] In `src/core/browser-api.service.ts`, implement thenable detection for `storage.local.get(keys)` and `storage.local.set(items)`; await Promise branch, fallback to callback with lastError check. (AC: 1)
- [ ] Break circular dependency in storage service
  - [ ] In `src/core/storage.service.ts`, remove `readStorageValue` import; add private `readValue<T>(key, validator, defaultValue)` and update `readTranslationLanguage`, `readSummarizationLevel`, `readPreprocessingEnabled`. (AC: 2)
- [ ] Test reset reliability
  - [ ] Update `BrowserApiService.__resetForTests()` to nullify `cachedBrowser` and `instance`. (AC: 3)
- [ ] Type‑safe sendMessage wrappers
  - [ ] Add overloads for `wrapSendMessage` in `src/core/chrome-adapter.ts` for runtime and tabs; remove `as { ... }` casts in adapt(). (AC: 4)
- [ ] Playwright .env loader
  - [ ] In `playwright.config.ts`, strip matching surrounding single or double quotes from values before assigning to `process.env`. (AC: 5)

## Dev Notes
Architecture context:
- The `BrowserApiService` adapts `chrome.*` to a promise‑based `MinimalBrowserAPI` and must be resilient across browsers. [Source: architecture.md#4.-cross-cutting-modules]
- Build/tests run in Chromium by default; Firefox compatibility is a product goal for the bundle. [Source: architecture.md#6.-browser-targets]
- Unit tests use Vitest; reliable adapter reset is necessary for isolation. [Source: architecture.md#7.-testing-strategy]

Files impacted:
- `src/core/browser-api.service.ts`, `src/core/storage.service.ts`, `src/core/chrome-adapter.ts`, `playwright.config.ts`.

Testing
- Unit: mock promise and callback storage APIs; verify correct paths taken and error propagation.
- Unit: verify `__resetForTests` allows re‑adapting after changing global runtime shape.
- E2E: basic flows remain working in Chromium; manual Gecko verification if applicable.

Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-27 | 0.1 | Draft story created | Scrum Master |

